#!/usr/bin/env ruby

# frozen_string_literal: true

require 'bundler/setup'
Bundler.require(:default, :development)

require 'base64'
require 'json'
require 'yaml'
require 'active_support/core_ext/object/blank'

BINTRAY_API_BASE = 'https://bintray.com/api/v1'
DATA_PATH = File.join(__dir__, '..', 'data')
BOTTLE_PACKAGES_FILE_PATH = File.join(DATA_PATH, 'bottle_packages.yml')

require_relative '../lib/state'
at_exit { State.save }

require_relative '../lib/progress_bar'
require_relative '../lib/fetch_bottle_packages'
require_relative '../lib/download_bottle_files'

# HOMEBREW_CORE_REMOTE = ENV.fetch('HOMEBREW_CORE_REMOTE', 'https://github.com/Homebrew/homebrew-core')
# HOMEBREW_CORE_REPO = '~/data/homebrew-core'
# `git clone --depth=1 #{HOMEBREW_CORE_REMOTE} #{HOMEBREW_CORE_REPO}`

begin
  FetchBottlePackages.new.run
  DownloadBottleFiles.new.run
  # DownloadNonBottles.new.run
rescue Interrupt
  # NOTE: This is most likely caused by user pressing "Ctrl+C".
  # Tearout operations are already taken care of inside `at_exit` block,
  # so nothing to do here.
rescue Net::OpenTimeout, RestClient::Exceptions::OpenTimeout
  puts 'Error: Network timeout. Please check your Internet connection.'.red
end
